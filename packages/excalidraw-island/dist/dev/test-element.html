<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Element Test</title>
    <style>
        body { 
            margin: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }
        excalidraw-island { 
            display: block; 
            width: 800px; 
            height: 400px; 
            border: 2px solid #007acc; 
            border-radius: 8px; 
            margin: 20px 0;
        }
        .test-results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        button {
            margin: 5px;
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üèùÔ∏è Excalidraw Island - React 18 Integration Test</h1>
    
    <div class="test-results" id="results">
        <div>Loading tests...</div>
    </div>
    
    <div id="event-log" style="margin: 20px 0; padding: 15px; background: #e8f4fd; border-radius: 5px;">
        <h3>Event Log</h3>
        <div id="event-list">Waiting for events...</div>
    </div>
    
    <div>
        <h3>Attribute Test Controls:</h3>
        <button onclick="testSetScale()">Set Scale to 1.5</button>
        <button onclick="testSetScale2()">Set Scale to 0.75</button>
        <button onclick="testToggleReadonly()">Toggle Readonly</button>
        <button onclick="testSetValidScene()">Set Valid Scene</button>
        <button onclick="testSetInvalidScene()">Set Invalid Scene</button>
        <button onclick="testRequestExport()">Request Export</button>
    </div>
    
    <!-- Test island with initial attributes -->
    <h3>Test Island (React 18 Inside)</h3>
    <excalidraw-island id="test-island" scale="1.0" readonly initial-scene='{"elements":[],"appState":{"viewBackgroundColor":"#ffffff"}}'></excalidraw-island>
    
    <script type="module" src="./dist/dev/excalidraw-island.js"></script>
    <script>
        // Test results container
        const results = document.getElementById('results');
        const island = document.getElementById('test-island');
        const eventLog = document.getElementById('event-list');
        
        let testResults = [];
        let eventCount = 0;
        let readyEventCount = 0;
        
        function addResult(test, success, message) {
            testResults.push({test, success, message, timestamp: new Date().toLocaleTimeString()});
            updateResults();
        }
        
        function updateResults() {
            results.innerHTML = testResults.map(({test, success, message, timestamp}) => 
                `<div class="${success ? 'success' : 'error'}">
                    ${success ? '‚úÖ' : '‚ùå'} [${timestamp}] ${test}: ${message}
                </div>`
            ).join('');
        }
        
        function logEvent(eventName, detail) {
            eventCount++;
            const eventDiv = document.createElement('div');
            eventDiv.innerHTML = `<strong>${eventCount}. ${eventName}</strong> [${new Date().toLocaleTimeString()}]${detail ? ': ' + JSON.stringify(detail, null, 2) : ''}`;
            eventDiv.style.marginBottom = '8px';
            eventDiv.style.padding = '4px';
            eventDiv.style.background = '#f0f8ff';
            eventDiv.style.borderLeft = '3px solid #007acc';
            eventLog.appendChild(eventDiv);
            eventLog.scrollTop = eventLog.scrollHeight;
            
            if (eventCount === 1) {
                eventLog.innerHTML = '';
                eventLog.appendChild(eventDiv);
            }
        }
        
        // Test functions
        function testSetScale() {
            island.scale = 1.5;
            const actualScale = island.scale;
            addResult('Set Scale to 1.5', actualScale === 1.5, `Expected 1.5, got ${actualScale}`);
        }
        
        function testSetScale2() {
            island.scale = 0.75;
            const actualScale = island.scale;
            addResult('Set Scale to 0.75', actualScale === 0.75, `Expected 0.75, got ${actualScale}`);
        }
        
        function testToggleReadonly() {
            const originalReadonly = island.readonly;
            island.readonly = !originalReadonly;
            const newReadonly = island.readonly;
            addResult('Toggle Readonly', newReadonly === !originalReadonly, 
                `Expected ${!originalReadonly}, got ${newReadonly}`);
        }
        
        function testSetValidScene() {
            const validScene = JSON.stringify({
                elements: [
                    { id: "test1", type: "rectangle", x: 100, y: 100, width: 50, height: 50 },
                    { id: "test2", type: "ellipse", x: 200, y: 200, width: 75, height: 75 }
                ],
                appState: { 
                    viewBackgroundColor: "#f0f0f0",
                    currentItemFontFamily: 1
                }
            });
            island['initial-scene'] = validScene;
            const actual = island['initial-scene'];
            addResult('Set Valid Scene', actual === validScene, 
                `Scene set successfully (${actual.length} chars)`);
        }
        
        function testSetInvalidScene() {
            const invalidScene = '{"invalid": "structure", "missing": "elements"}';
            island['initial-scene'] = invalidScene;
            const actual = island['initial-scene'];
            // Should be reset to empty since invalid
            addResult('Set Invalid Scene', actual === invalidScene, 
                `Invalid scene handling: ${actual.substring(0, 50)}...`);
        }
        
        function testRequestExport() {
            try {
                island.requestExport({type: 'png'});
                addResult('Request Export', true, 'Export method called successfully');
            } catch (error) {
                addResult('Request Export', false, `Error: ${error.message}`);
            }
        }
        
        // Event listeners for testing (set up first)
        island.addEventListener('ready', (event) => {
            readyEventCount++;
            logEvent('READY EVENT', event.detail);
            
            addResult('Ready Event', true, `Ready event fired (count: ${readyEventCount})`);
            
            // Test that ready fires only once
            if (readyEventCount > 1) {
                addResult('Ready Event Uniqueness', false, `Ready fired ${readyEventCount} times - should be once`);
            } else {
                setTimeout(() => {
                    addResult('Ready Event Uniqueness', readyEventCount === 1, `Ready fired exactly once`);
                }, 2000);
            }
            
            console.log('Island ready event:', event);
        });
        
        island.addEventListener('scenechange', (event) => {
            logEvent('SCENE CHANGE EVENT', event.detail);
            addResult('Scene Change Event', true, `Scene changed`);
            console.log('Scene change event:', event.detail);
        });
        
        island.addEventListener('export', (event) => {
            logEvent('EXPORT EVENT', event.detail);
            addResult('Export Event', true, `Export completed: ${event.detail.type}`);
            console.log('Export event:', event.detail);
        });
        
        // Automatic tests on load
        window.addEventListener('load', () => {
            logEvent('PAGE LOADED', 'Running automatic tests...');
            
            // Test 1: Element exists and is defined
            const islandElement = document.querySelector('excalidraw-island');
            addResult('Element Creation', !!islandElement, 
                islandElement ? 'Element found in DOM' : 'Element not found');
            
            // Test 2: Custom element is properly defined
            const isCustomElement = customElements.get('excalidraw-island');
            addResult('Custom Element Registration', !!isCustomElement, 
                isCustomElement ? 'Custom element is registered' : 'Custom element not registered');
            
            // Test 3: Shadow DOM is attached
            const hasShadowRoot = !!island.shadowRoot;
            addResult('Shadow DOM', hasShadowRoot, 
                hasShadowRoot ? 'Shadow DOM attached' : 'No shadow DOM found');
            
            // Test 4: Initial attributes are recognized
            const initialScale = island.scale;
            const initialReadonly = island.readonly;
            const initialScene = island['initial-scene'];
            
            addResult('Initial Scale', initialScale === 1.0, `Expected 1.0, got ${initialScale}`);
            addResult('Initial Readonly', initialReadonly === true, `Expected true, got ${initialReadonly}`);
            addResult('Initial Scene Valid', initialScene.length > 50, 
                `Scene data: ${initialScene.length} characters`);
            
            // Test 5: React container exists in shadow DOM
            const reactContainer = island.shadowRoot.querySelector('.react-container');
            addResult('React Container', !!reactContainer, 
                reactContainer ? 'Found .react-container' : '.react-container not found');
            
            // Test 6: Check if React content is rendered
            setTimeout(() => {
                const shadowContent = island.shadowRoot.innerHTML;
                const hasReactContent = shadowContent.includes('Island Ready') || shadowContent.includes('React');
                addResult('React Content Rendered', hasReactContent, 
                    hasReactContent ? 'React component rendered' : 'No React content found');
                
                // Test props visibility in React component
                const hasPropsDisplay = shadowContent.includes('Current Props') || shadowContent.includes('Scale:');
                addResult('Props Display', hasPropsDisplay, 
                    hasPropsDisplay ? 'Props displayed in React component' : 'Props display not found');
            }, 500);
        });
    </script>
</body>
</html>